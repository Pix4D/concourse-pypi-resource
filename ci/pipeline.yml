---
resource_types:

- name: pypi
  type: docker-image
  source:
    repository: cfplatformeng/concourse-pypi-resource
    tag: {{pypi-resource-tag}}

- name: pypi-acceptance
  type: docker-image
  source:
    repository: cfplatformeng/concourse-pypi-resource
    tag: acceptance

resources:

- name: code
  type: git
  source:
    uri: http://github.com/cf-platform-eng/concourse-pypi-resource

- name: docker-acceptance
  type: docker-image
  source:
    repository: cfplatformeng/concourse-pypi-resource
    tag: acceptance
    username: {{docker-username}}
    password: {{docker-password}}

- name: docker-production
  type: docker-image
  source:
    repository: cfplatformeng/concourse-pypi-resource
    tag: latest
    username: {{docker-username}}
    password: {{docker-password}}

- name: test-package-version
  type: semver
  source:
    driver: git
    uri: git@github.com:cf-platform-eng/test-python-package
    branch: master
    file: version
    private_key: {{github-private-key}}

- name: package-repo
  type: git
  source:
    uri: http://github.com/cf-platform-eng/test-python-package

- name: acceptance-test-resource
  type: pypi-acceptance
  source:
    name: cf-platform-eng
    test: true
    username: {{pypi-username}}
    password: {{pypi-password}}

jobs:

- name: unit-test
  plan:
  - get: code
    trigger: true
  - task: run-unit-tests
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: python
          tag: '2'
      inputs:
      - name: code
      run:
        path: sh
        args:
        - -exc
        - |
          apt -q update
          apt -yq install pipenv
          cd code && pipenv run make test

- name: package
  serial: true
  plan:
  - get: code
    trigger: true
    passed: [unit-test]
  - task: package
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: python
          tag: '2'
      inputs:
      - name: code
      outputs:
      - name: docker-build
      run:
        path: sh
        args:
        - -exc
        - |
          apt -q update
          apt -yq install pipenv
          cd code && pipenv run make sdist
          cp -r Dockerfile dist ../docker-build/
  - put: docker-acceptance
    params:
      build: docker-build

- name: acceptance-test
  serial: true
  plan:
  - get: docker-acceptance
    trigger: true
    passed: [package]
  - put: test-package-version
    params:
      bump: patch
  - get: package-repo
  - task: build-package
    config:
      image_resource:
        type: docker-image
        source:
          repository: python
          tag: latest
      platform: linux
      inputs:
      - name: package-repo
      outputs:
      - name: package-out
      run:
        path: sh
        args:
        - -exc
        - |
          cd package-repo
          python setup.py sdist
          cp dist/*.tar.gz ../package-out/
  - put: acceptance-test-resource
    params:
      glob: package-out/*.tar.gz
  - get: acceptance-test-resource

- name: promote-to-prod
  plan:
  - get: docker-acceptance
    passed: [acceptance-test]
    params:
      save: true
  - put: docker-production
    params:
      load: docker-acceptance
